<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>üéì ¬øEn qu√© trabajan los egresados de la FEIPU?</title>

<!-- D3 v7 -->
<script src="https://d3js.org/d3.v7.min.js"></script>
<!-- SheetJS -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
  :root { --bg:#ffffff; --card:#f9fafb; --muted:#6b7280; --border:#e5e7eb; --ink:#111827; }
  * { box-sizing: border-box; }
  body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial; background:var(--bg); color:var(--ink); }
  header { padding:16px 20px; background:#111827; color:#fff; display:flex; align-items:center; gap:12px; }
  h1 { font-size:18px; margin:0; line-height:1.2; }
  .sub { color:#cbd5e1; font-size:12px; margin-top:4px; }
  .wrap { display:grid; grid-template-columns: 360px 1fr; gap:16px; padding:16px; }
  .panel { background:var(--card); border:1px solid var(--border); border-radius:12px; padding:12px; }
  label { display:block; font-weight:600; margin:10px 0 6px; }
  select, input[type="text"] { width:100%; padding:10px; border-radius:10px; border:1px solid #d1d5db; background:#fff; }
  .legend { display:flex; flex-wrap:wrap; gap:6px; margin-top:10px; }
  .legend-item { display:flex; align-items:center; gap:6px; padding:6px 8px; border-radius:8px; background:#fff; border:1px solid var(--border); }
  .legend-swatch { width:12px; height:12px; border-radius:3px; }
  #chart { width:100%; height:70vh; min-height:480px; border:1px solid var(--border); border-radius:12px; background:#fff; }
  .tooltip { position: fixed; pointer-events:none; background:rgba(17,24,39,0.92); color:#fff; padding:10px 12px; border-radius:10px; font-size:12px; opacity:0; transition:opacity .12s; z-index:10; max-width:85vw; }
  .muted { color:var(--muted); }
  .small { font-size:12px; }
  .row { display:flex; gap:8px; }
  .about h2 { margin:0 0 6px; font-size:16px; }
  .about p { margin:6px 0; font-size:14px; line-height:1.4; }

  /* ======== MODO M√ìVIL (‚â§768px) SIN ROMPER ESCRITORIO ======== */
  #toggleFilters {
    display:none;
    margin-left:auto;
    background:#10b981; /* verde discreto */
    color:#0b1b14;
    border: none;
    padding:8px 10px;
    border-radius:10px;
    font-weight:700;
  }
  @media (max-width: 768px) {
    h1 { font-size:16px; }
    .sub { font-size:11px; }
    #toggleFilters { display:inline-block; }
    .wrap {
      grid-template-columns: 1fr; 
      gap:12px; 
      padding:12px;
    }
    /* Por defecto, en m√≥vil mostramos SOLO el gr√°fico para aprovechar pantalla */
    aside.panel { display:none; }
    main.panel { display:block; }
    body.show-filters aside.panel { display:block; }
    body.show-filters main.panel { display:none; }

    /* Mejorar altura del gr√°fico en m√≥vil */
    #chart { height:64vh; min-height:320px; }

    /* Aumentar hit area en selects y entradas */
    select, input[type="text"] { padding:12px; font-size:16px; } /* evita zoom iOS */
    .legend-item { padding:8px 10px; }
  }

  /* Accesibilidad m√≠nima foco */
  :focus-visible {
    outline: 2px solid #60a5fa; outline-offset: 2px;
  }
</style>
</head>
<body>
<header>
  <div style="display:flex; flex-direction:column;">
    <h1>üéì ¬øEn qu√© trabajan los egresados de la FEIPU?</h1>
    <div class="sub" id="fileMeta">Cargando datos‚Ä¶</div>
  </div>
  <!-- Bot√≥n solo visible en m√≥vil para alternar Filtros <-> Gr√°fico -->
  <button id="toggleFilters" aria-expanded="false" aria-controls="filters">Filtros</button>
</header>

<div class="wrap">
  <!-- Panel izquierdo: explicaci√≥n + filtros -->
  <aside id="filters" class="panel">
    <section class="about">
      <h2>Acerca de esta visualizaci√≥n</h2>
      <p> Este es el resultado de un ejercicio de categorizaci√≥n llevado a cabo con un modelo bge-m3, bajo supervisi√≥n manual.
      Las categor√≠as tambi√©n fueron definidas manualmente. Puedes filtrar por <b>PROGRAMA</b> y <b>A√ëO DE GRADO</b>. La categor√≠a
      'otro' indica que no hubo suficiente informaci√≥n para categorizar. Pasa el mouse o toca para ver detalles.</p>
      <p class="small muted"> Hecho por <a href="https://juancotes.github.io/Sebastian-Cotes-Ontibon/" target="_blank">Sebasti√°n Cotes Ontib√≥n</a>. Fuente: base de datos de egresados FEIPU anonimizada.</p>
      <div id="status" class="small muted" style="margin-top:6px;"></div>
    </section>

    <label for="programaSel">Filtrar por PROGRAMA</label>
    <input id="programaFilter" type="text" placeholder="Buscar programa‚Ä¶" inputmode="search" />
    <select id="programaSel" multiple size="8"></select>

    <label for="gradoSel">Filtrar por A√ëO DE GRADO</label>
    <div class="row" style="align-items:flex-start;">
      <select id="gradoSel" multiple size="8" style="flex:1;"></select>
      <div style="display:flex;flex-direction:column;gap:6px;width:140px;">
        <input id="minYear" type="text" placeholder="m√≠n (e.g. 2015)" inputmode="numeric" />
        <input id="maxYear" type="text" placeholder="m√°x (e.g. 2025)" inputmode="numeric" />
      </div>
    </div>

    <div class="legend" id="legend"></div>
    <div style="margin-top:10px;" class="muted small">Tip: usa Ctrl/‚åò o Shift para seleccionar varios; en m√≥vil puedes tocar para seleccionar uno y mantener para multiselecci√≥n (seg√∫n navegador).</div>
  </aside>

  <!-- Panel derecho: gr√°fico + detalles -->
  <main class="panel">
    <div id="chart" aria-label="Treemap por categor√≠a"></div>
    <div id="details" class="details">
      <div class="muted">Haz clic o toca un rect√°ngulo para ver detalles.</div>
    </div>
  </main>
</div>

<div id="tooltip" class="tooltip" role="tooltip" aria-hidden="true"></div>

<script>
/* ============================ CONFIG ============================ */
const DEFAULT_XLSX_URL = "https://raw.githubusercontent.com/juancotes/egresados-FEIPU/main/Egresados%20FEIPU.xlsx";
/* =============================================================== */

const state = {
  cleaned: [],
  cols: { programa: null, grado: null, tema: null },
  sheetName: null,
  fileName: null,
  categories: [],
  color: null
};

const el = {
  fileMeta: document.getElementById('fileMeta'),
  status: document.getElementById('status'),
  programaFilter: document.getElementById('programaFilter'),
  programaSel: document.getElementById('programaSel'),
  gradoSel: document.getElementById('gradoSel'),
  minYear: document.getElementById('minYear'),
  maxYear: document.getElementById('maxYear'),
  chart: document.getElementById('chart'),
  legend: document.getElementById('legend'),
  tooltip: document.getElementById('tooltip'),
  details: document.getElementById('details'),
  toggleFilters: document.getElementById('toggleFilters'),
  filters: document.getElementById('filters')
};

/* ======= UI: Alternar filtros en m√≥vil sin afectar escritorio ======= */
el.toggleFilters.addEventListener('click', () => {
  const showing = document.body.classList.toggle('show-filters');
  el.toggleFilters.setAttribute('aria-expanded', String(showing));
  el.toggleFilters.textContent = showing ? 'Ver gr√°fico' : 'Filtros';
});

/* ======= Utilidades ======= */
function setStatus(msg, isErr=false){
  el.status.textContent = msg;
  el.status.className = "small " + (isErr ? "err" : "muted");
}
function normalize(s){ return String(s ?? "").trim().toLowerCase().replace(/\s+/g,' '); }
function extractYear(v){
  if (v == null || v === "") return null;
  const n = Number(v);
  if (!Number.isNaN(n)) { const y = Math.round(n); if (y>=1950 && y<=2100) return y; }
  const s = String(v); const m = s.match(/(19|20)\d{2}/);
  if (m){ const y = Number(m[0]); if (y>=1950 && y<=2100) return y; }
  const d = new Date(s); if (!isNaN(d.getTime())) { const y = d.getFullYear(); if (y>=1950 && y<=2100) return y; }
  return null;
}
function detectColumns(rows){
  if (!rows.length) throw new Error("La hoja no tiene registros.");
  const cols = Object.keys(rows[0] ?? {});
  const byNorm = new Map(cols.map(c => [normalize(c), c]));
  const find = (patterns) => { for (const p of patterns){ for (const [nk, orig] of byNorm.entries()){ if (p.test(nk)) return orig; } } return null; };
  const programa = find([/\bprograma\b/]);
  const grado    = find([/\bgrado\b/, /\ba√±o.*grad/, /\ba√±o.*egres/, /\ba√±o\b/, /\byear\b/]);
  const tema     = find([/\btop1_categoria\b/, /\btema(?:\s+de)?\s+trabajo\b/, /\btema\b/]);
  return { programa, grado, tema };
}
function cleanRows(rows, cols){
  const out = [], counts = new Map();
  const tmp = rows.map(r => {
    const temaRaw = r[cols.tema];
    const temaStr = (temaRaw==null?"":String(temaRaw).trim());
    const key = normalize(temaStr);
    if (key) counts.set(key, (counts.get(key)||0)+1);
    return { r, key, temaStr };
  });
  const key2canon = new Map();
  for (const t of tmp){ if (t.key && !key2canon.has(t.key)) key2canon.set(t.key, t.temaStr); }
  for (const row of rows){
    const PROGRAMA = (row[cols.programa]==null || String(row[cols.programa]).trim()==="") ? null : String(row[cols.programa]).trim();
    const GRADO    = extractYear(row[cols.grado]);
    const temaKey  = normalize(row[cols.tema]);
    const TEMA     = (!temaKey ? null : key2canon.get(temaKey) || String(row[cols.tema]).trim());
    if (TEMA) out.push({ PROGRAMA, GRADO, "Top1_Categoria": TEMA });
  }
  return out;
}
function uniq(arr){ return Array.from(new Set(arr.filter(v => v!=null))); }

function fillSelect(sel, options){ sel.innerHTML = ""; for (const o of options){ const opt=document.createElement('option'); opt.value=o; opt.textContent=String(o); sel.appendChild(opt);} }

function buildFilters(){
  const programas = uniq(state.cleaned.map(d => d.PROGRAMA)).sort((a,b)=>(a||"").localeCompare(b||""));
  const years     = uniq(state.cleaned.map(d => d.GRADO)).sort((a,b)=>(a??0)-(b??0));
  fillSelect(el.programaSel, programas);
  fillSelect(el.gradoSel, years);
  el.minYear.value = years.length ? years[0] : "";
  el.maxYear.value = years.length ? years[years.length-1] : "";
}
function getSelected(sel){ return Array.from(sel.selectedOptions).map(o => o.value); }
function applyFilters(){
  const selProg = getSelected(el.programaSel);
  const selGrad = getSelected(el.gradoSel).map(v => Number(v));
  const minY = Number(el.minYear.value), maxY = Number(el.maxYear.value);
  const useRange = Number.isFinite(minY) || Number.isFinite(maxY);
  return state.cleaned.filter(d => {
    const okProg = selProg.length ? selProg.includes(d.PROGRAMA) : true;
    const okGradList = selGrad.length ? selGrad.includes(d.GRADO) : true;
    const okRange = useRange ? (d.GRADO!=null && (!Number.isFinite(minY)||d.GRADO>=minY) && (!Number.isFinite(maxY)||d.GRADO<=maxY)) : true;
    return okProg && okGradList && okRange;
  });
}
function aggregateByTema(data){
  const m = new Map();
  for (const r of data){ const k = r["Top1_Categoria"] || "‚Äî"; m.set(k, (m.get(k)||0)+1); }
  return Array.from(m, ([name,value]) => ({name,value})).sort((a,b)=>b.value-a.value);
}
function drawLegend(categories, color){
  const sel = d3.select(el.legend).selectAll(".legend-item").data(categories, d=>d);
  sel.exit().remove();
  const enter = sel.enter().append("div").attr("class","legend-item");
  enter.append("div").attr("class","legend-swatch").style("background", d => color(d));
  enter.append("div").text(d => d);
}
function renderTreemap(){
  const data = applyFilters();
  const total = data.length;
  const agg = aggregateByTema(data);
  const color = state.color || d3.scaleOrdinal(d3.schemeTableau10).domain(
    Array.from(new Set(state.cleaned.map(d => d["Top1_Categoria"]).filter(Boolean))).sort((a,b)=>a.localeCompare(b))
  );
  drawLegend(agg.map(d=>d.name), color);

  el.chart.innerHTML = "";
  const width = el.chart.clientWidth, height = el.chart.clientHeight;

  const root = d3.hierarchy({ name:"root", children: agg }).sum(d=>d.value).sort((a,b)=>b.value-a.value);
  d3.treemap().size([width,height]).paddingInner(2).round(true)(root);

  const svg = d3.select("#chart").append("svg").attr("width",width).attr("height",height);

  const g = svg.selectAll("g").data(root.leaves()).join("g")
    .attr("transform", d => `translate(${d.x0},${d.y0})`)
    .on("mousemove", (ev,d) => {
      const {x,y} = getPointer(ev);
      showTooltip(d, x, y, total);
    })
    .on("mouseleave", () => hideTooltip())
    .on("click", (ev,d) => {
      const pct = total ? ((d.data.value/total)*100).toFixed(1) : 0;
      el.details.innerHTML = `<div><b>Categor√≠a:</b> ${d.data.name}</div><div><b>Conteo:</b> ${d.data.value}</div><div><b>% del total:</b> ${pct}%</div>`;
      // En m√≥vil, al tocar mostramos el tooltip unos ms para feedback
      if (isTouch()) {
        const {x,y} = getPointer(ev);
        showTooltip(d, x, y, total);
        setTimeout(hideTooltip, 1200);
      }
    })
    // Soporte t√°ctil expl√≠cito
    .on("touchstart", (ev,d) => {
      const {x,y} = getPointer(ev);
      showTooltip(d, x, y, total);
    }, {passive:true})
    .on("touchend", () => hideTooltip(), {passive:true});

  g.append("rect")
    .attr("width", d => Math.max(0, d.x1-d.x0))
    .attr("height", d => Math.max(0, d.y1-d.y0))
    .attr("fill", d => color(d.data.name))
    .attr("rx",8).attr("ry",8);

  g.append("foreignObject")
    .attr("width", d => Math.max(0, d.x1-d.x0))
    .attr("height", d => Math.max(0, d.y1-d.y0))
    .append("xhtml:div")
    .style("width","100%").style("height","100%").style("display","flex").style("align-items","center").style("justify-content","center")
    .style("text-align","center").style("padding","6px").style("font-size","12px").style("font-weight","600").style("color","#111827").style("pointer-events","none")
    .html(d => {
      const area=(d.x1-d.x0)*(d.y1-d.y0), pct = total?((d.data.value/total)*100).toFixed(1):0;
      // Etiquetas menos exigentes en m√≥vil para legibilidad
      const threshold = window.matchMedia('(max-width: 768px)').matches ? 3500 : 5000;
      return area>threshold ? `${d.data.name} ¬∑ ${pct}%` : "";
    });
}

/* ---------- Tooltip helpers con soporte t√°ctil y anti-overflow ---------- */
function isTouch(){ return ('ontouchstart' in window) || navigator.maxTouchPoints > 0; }
function getPointer(ev){
  if (ev.touches && ev.touches[0]) return { x: ev.touches[0].clientX, y: ev.touches[0].clientY };
  return { x: ev.clientX ?? 0, y: ev.clientY ?? 0 };
}
function showTooltip(d, clientX, clientY, total){
  const pct = total ? ((d.data.value/total)*100).toFixed(1) : 0;
  el.tooltip.innerHTML = `<b>${d.data.name}</b><br>Conteo: ${d.data.value}<br>% del total: ${pct}%`;
  el.tooltip.style.opacity = 1;
  // Evitar que se salga por el borde en m√≥vil
  const pad = 12;
  const tw = el.tooltip.offsetWidth || 160;
  const th = el.tooltip.offsetHeight || 60;
  let left = clientX + pad, top = clientY - th - 8;
  if (left + tw > window.innerWidth) left = window.innerWidth - tw - pad;
  if (top < 0) top = clientY + pad;
  el.tooltip.style.left = left + "px";
  el.tooltip.style.top  = top  + "px";
  el.tooltip.setAttribute('aria-hidden','false');
}
function hideTooltip(){
  el.tooltip.style.opacity = 0;
  el.tooltip.setAttribute('aria-hidden','true');
}

/* ---------- Carga de datos (solo autom√°tica; sin UI) ---------- */
function pickBestSheet(workbook){
  let best = { name:null, score:-1 };
  workbook.SheetNames.forEach(name => {
    const ws = workbook.Sheets[name];
    const json = XLSX.utils.sheet_to_json(ws, {defval: null});
    if (!json.length) return;
    const cols = Object.keys(json[0] ?? {}), nc = cols.map(c => normalize(c));
    const hasTema = nc.some(c => c==="top1_categoria" || (c.includes("tema") && c.includes("trabajo")) || c==="tema de trabajo" || c==="temas de trabajo");
    const hasProg = nc.some(c => c.includes("programa"));
    const hasGrad = nc.some(c => c.includes("grado") || (c.includes("a√±o") && (c.includes("grad")||c.includes("egres"))) || c==="year");
    const score = (hasTema?1:0) + (hasProg?1:0) + (hasGrad?1:0) + Math.min(cols.length,6)*0.05;
    if (score > best.score) best = { name, score };
  });
  return best.name || workbook.SheetNames[0];
}
async function loadFromUrl(url){
  setStatus("Descargando Excel‚Ä¶");
  const res = await fetch(url);
  if (!res.ok) throw new Error(`No se pudo descargar el archivo (${res.status})`);
  const ab = await res.arrayBuffer();
  setStatus("Parseando Excel‚Ä¶");
  const wb = XLSX.read(ab, { type: "array" });
  const sheet = pickBestSheet(wb);
  const ws = wb.Sheets[sheet];
  const rows = XLSX.utils.sheet_to_json(ws, { defval: null });
  return { rows, sheet, fileName: url.split("/").pop() };
}
async function bootstrapFromRows(rows, sheet, fileName){
  const cols = detectColumns(rows);
  if (!cols.tema) throw new Error("No encontr√© la columna 'Top1_Categoria' (o 'Tema de trabajo').");
  state.cols = cols;
  state.cleaned = cleanRows(rows, cols);
  state.sheetName = sheet;
  state.fileName = fileName;
  state.categories = Array.from(new Set(state.cleaned.map(d => d["Top1_Categoria"]).filter(Boolean))).sort((a,b)=>a.localeCompare(b));
  state.color = d3.scaleOrdinal(d3.schemeTableau10).domain(state.categories);
  el.fileMeta.textContent = `${fileName || 'archivo.xlsx'} ¬∑ hoja: ${sheet}`;
  setStatus(`Registros v√°lidos: ${state.cleaned.length}`);
  buildFilters();
  renderTreemap();
}

/* ---------- Reactividad filtros ---------- */
document.getElementById('programaSel').addEventListener('change', renderTreemap);
document.getElementById('gradoSel').addEventListener('change', renderTreemap);
document.getElementById('minYear').addEventListener('input', renderTreemap);
document.getElementById('maxYear').addEventListener('input', renderTreemap);
el.programaFilter.addEventListener('input', () => {
  const q = normalize(el.programaFilter.value || "");
  const programas = uniq(state.cleaned.map(d=>d.PROGRAMA)).filter(v => v!=null);
  const filtered = q ? programas.filter(p => normalize(p).includes(q)) : programas;
  fillSelect(el.programaSel, filtered.sort((a,b)=>a.localeCompare(b)));
});

/* ---------- Auto-carga inicial ---------- */
(async function init(){
  try{
    const qs = new URL(location.href).searchParams.get("data");
    const url = (qs || DEFAULT_XLSX_URL).trim();
    const info = await loadFromUrl(url);
    await bootstrapFromRows(info.rows, info.sheet, info.fileName);

    // Si se abre en m√≥vil, mostrar primero el gr√°fico (filtros ocultos por defecto)
    if (window.matchMedia('(max-width: 768px)').matches) {
      document.body.classList.remove('show-filters');
      el.toggleFilters.setAttribute('aria-expanded','false');
      el.toggleFilters.textContent = 'Filtros';
    }
    // Re-render on resize para recalcular treemap
    let rid = null;
    window.addEventListener('resize', () => {
      cancelAnimationFrame(rid);
      rid = requestAnimationFrame(renderTreemap);
    });
  }catch(e){ setStatus(`Error: ${e.message}`, true); }
})();
</script>
</body>
</html>

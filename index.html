<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Panel interactivo — Egresados FEIPU</title>
  <style>
    :root{
      --bg:#0e0f12;--card:#16181d;--muted:#8b93a7;--text:#e9edf5;--accent:#6aa9ff;--accent2:#9b8cff;--ok:#4dd4ac;--warn:#ffcd57;--bad:#ff7d7d;
    }
    html,body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}
    .wrap{max-width:1200px;margin:28px auto;padding:0 16px}
    h1{font-weight:750;letter-spacing:.2px;margin:0 0 6px}
    .sub{color:var(--muted);margin:0 0 22px}
    .grid{display:grid;gap:14px}
    .g-4{grid-template-columns:repeat(4,1fr)}
    .g-3{grid-template-columns:repeat(3,1fr)}
    .g-2{grid-template-columns:repeat(2,1fr)}
    @media(max-width:1100px){.g-4{grid-template-columns:repeat(2,1fr)}}
    @media(max-width:720px){.g-4,.g-3,.g-2{grid-template-columns:1fr}}
    .card{background:var(--card);border:1px solid #222630;border-radius:16px;padding:16px;box-shadow:0 6px 18px rgba(0,0,0,.25)}
    .kpi{display:flex;align-items:baseline;gap:10px}
    .kpi .n{font-size:28px;font-weight:800}
    .kpi .l{color:var(--muted)}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;font-size:12px;border:1px solid #2a2f3b;background:#121419}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    select, input[type="text"], input[type="number"]{background:#0f1217;color:var(--text);border:1px solid #2a2f3b;border-radius:10px;padding:10px 12px;font-size:14px;min-width:160px}
    select[multiple]{height:132px}
    button{background:#1b2230;color:var(--text);border:1px solid #2b3446;border-radius:12px;padding:10px 14px;cursor:pointer}
    button:hover{filter:brightness(1.15)}
    .chart-card{display:grid;grid-template-rows:auto 1fr;min-height:360px}
    .chart-ctn{position:relative;height:300px}
    .table{width:100%;border-collapse:separate;border-spacing:0 8px}
    .table thead th{font-size:12px;color:var(--muted);text-align:left;padding:0 10px}
    .tr{background:#0f1217;border:1px solid #262b36}
    .tr td{padding:10px 10px;border-top:1px solid #262b36;border-bottom:1px solid #262b36}
    .tr:first-child td{border-top-left-radius:12px;border-top-right-radius:12px}
    .tr:last-child td{border-bottom-left-radius:12px;border-bottom-right-radius:12px}
    .muted{color:var(--muted)}
    .foot{display:flex;gap:10px;align-items:center;justify-content:flex-end;margin-top:8px}
    .tag{display:inline-flex;padding:2px 8px;border-radius:999px;border:1px solid #2b3446;font-size:12px;color:var(--muted)}
    .hint{font-size:12px;color:var(--muted);margin-top:6px}
    .hl-otro{outline:2px dashed var(--warn);outline-offset:3px;border-radius:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Panel interactivo — Egresados FEIPU</h1>
    <p class="sub">Clasificación temática (Top1_Categoria) derivada de bge-m3 (Ollama). Filtra, explora y descarga.</p>

    <!-- Controles -->
    <div class="grid g-4">
      <div class="card">
        <div class="row" style="justify-content:space-between;align-items:center;margin-bottom:8px">
          <strong>Filtros</strong>
          <button id="btn-clear">Limpiar</button>
        </div>
        <div class="grid g-2">
          <div>
            <label class="muted">Programa</label><br/>
            <select id="f-programa" multiple></select>
          </div>
          <div>
            <label class="muted">Sector</label><br/>
            <select id="f-sector" multiple></select>
          </div>
          <div>
            <label class="muted">Año de grado (min–max)</label><br/>
            <div class="row">
              <input id="f-min" type="number" placeholder="mín"/>
              <input id="f-max" type="number" placeholder="máx"/>
            </div>
          </div>
          <div>
            <label class="muted">Tema (Top1_Categoria)</label><br/>
            <select id="f-top1" multiple></select>
            <div class="hint">Consejo: selecciona “Otro” para auditar casos ambiguos.</div>
          </div>
        </div>
      </div>
      <div class="card kpi"><span class="n" id="k-total">–</span><span class="l">Registros</span></div>
      <div class="card kpi"><span class="n" id="k-cat">–</span><span class="l">Temas (Top1_Categoria)</span></div>
      <div class="card kpi"><span class="n" id="k-otro">–</span><span class="l">% "Otro"</span></div>
    </div>

    <!-- Gráficas principales -->
    <div class="grid g-2" style="margin-top:14px">
      <div class="card chart-card" id="card-cats">
        <div class="row" style="justify-content:space-between;align-items:center">
          <strong>Distribución por tema (Top1_Categoria)</strong>
          <span class="tag" id="tag-top">Top 12</span>
        </div>
        <div class="chart-ctn"><canvas id="chartCats"></canvas></div>
        <div class="hint">Resalta\: “Otro” para control de calidad de la clasificación.</div>
      </div>
      <div class="card chart-card">
        <strong>Temas × Sector (Top 8 temas)</strong>
        <div class="chart-ctn"><canvas id="chartStack"></canvas></div>
      </div>
    </div>

    <div class="grid g-2" style="margin-top:14px">
      <div class="card chart-card">
        <strong>Egresados por año de grado</strong>
        <div class="chart-ctn"><canvas id="chartYear"></canvas></div>
      </div>
      <div class="card chart-card">
        <strong>Top temas por programa</strong>
        <div class="chart-ctn"><canvas id="chartProg"></canvas></div>
      </div>
    </div>

    <!-- Tabla -->
    <div class="card" style="margin-top:14px">
      <div class="row" style="justify-content:space-between;align-items:center;margin-bottom:6px">
        <strong>Detalle de registros</strong>
        <div class="row">
          <input id="q" type="text" placeholder="Buscar en Cargo, Empresa o Descripción…" style="min-width:300px"/>
          <button id="btn-csv">Descargar CSV</button>
        </div>
      </div>
      <table class="table" id="tbl">
        <thead>
          <tr>
            <th>PROGRAMA</th>
            <th>GRADO</th>
            <th>Sector</th>
            <th>Top1_Categoria</th>
            <th>Cargo</th>
            <th>Empresa</th>
            <th>Descripción</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
      <div class="foot">
        <span class="tag" id="pinfo">–</span>
        <div class="row">
          <button id="prev">‹</button>
          <button id="next">›</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Librerías desde CDN (permite un único HTML en GitHub Pages) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Datos embebidos como JSON en el propio HTML -->
  <script type="application/json" id="raw-data"></script>

  <script>
  // Inserta aquí el JSON (sustituido automáticamente al pegar este archivo desde ChatGPT)
  const RAW_JSON = `[{"PROGRAMA":"RELACIONES INTERNACIONALES","GRADO":2011,"Sector":"Privado","Descripción":"Docente e Investigadora en la Escuela Intercultural de Diplomacia Indígena (EIDI) Universidad del Rosario.","Top1_Categoria":"Educación y academia","Cargo":"Docente e Investigadora en la Escuela Intercultural de Diplomacia Indígena (EIDI)","Empresa":"Universidad del Rosario"},{"PROGRAMA":"RELACIONES INTERNACIONALES","GRADO":2011,"Sector":"Privado","Descripción":"Director de inversiones segmento empresarial    .","Top1_Categoria":"Inversiones, financiero y seguros","Cargo":"Director de inversiones segmento empresarial    ","Empresa":""},{"PROGRAMA":"CIENCIA POLÍTICA Y GOBIERNO","GRADO":2005,"Sector":"Privado","Descripción":"Consultor estrategia ambiental, sostenibilidad, sociales, asuntos gubernamentales   .","Top1_Categoria":"Ambiente y agricultura","Cargo":"Consultor estrategia ambiental, sostenibilidad, sociales, asuntos gubernamentales   ","Empresa":""},{"PROGRAMA":"RELACIONES INTERNACIONALES","GRADO":2005,"Sector":"Privado","Descripción":"Consultor estrategia ambiental, sostenibilidad, sociales, asuntos gubernamentales   .","Top1_Categoria":"Ambiente y agricultura","Cargo":"Consultor estrategia ambiental, sostenibilidad, sociales, asuntos gubernamentales   ","Empresa":""},{"PROGRAMA":"RELACIONES INTERNACIONALES","GRADO":2018,"Sector":"Público","Descripción":"Asesor de Asuntos Culturales y Cooperación Internacional.    .","Top1_Categoria":"Relaciones internacionales y cooperación internacional","Cargo":"Asesor de Asuntos Culturales y Cooperación Internacional.    ","Empresa":"Misión diplomática."}]`;
  document.getElementById('raw-data').textContent = RAW_JSON;

  const DATA = JSON.parse(document.getElementById('raw-data').textContent).map(r=>({
    PROGRAMA: String(r.PROGRAMA||'').trim(),
    GRADO: Number(r.GRADO)||null,
    Sector: String(r.Sector||'').trim(),
    Descripción: String(r.Descripción||''),
    Top1_Categoria: String(r.Top1_Categoria||'').trim(),
    Cargo: String(r.Cargo||''),
    Empresa: String(r.Empresa||''),
  }));

  // Utilidades
  const uniq = a => [...new Set(a)];
  const sortByValDesc = obj => Object.entries(obj).sort((a,b)=>b[1]-a[1]);
  const by = k => (a,b)=> (a[k]||'').localeCompare(b[k]||'');
  function fmt(n){return n.toLocaleString('es-CO')}

  // Estado de filtros
  const S = {prog:[], sector:[], cats:[], min:null, max:null, q:'', page:1, size:20};

  // Poblar selects
  const selProg = document.getElementById('f-programa');
  const selSector = document.getElementById('f-sector');
  const selTop = document.getElementById('f-top1');
  const anos = uniq(DATA.map(d=>d.GRADO).filter(Boolean)).sort((a,b)=>a-b);
  const minI = document.getElementById('f-min');
  const maxI = document.getElementById('f-max');
  const putOpts=(el,vals)=>{ el.innerHTML=''; vals.forEach(v=>{const o=document.createElement('option');o.value=v;o.textContent=v;el.appendChild(o)}) }
  putOpts(selProg, uniq(DATA.map(d=>d.PROGRAMA)).sort());
  putOpts(selSector, uniq(DATA.map(d=>d.Sector)).sort());
  putOpts(selTop, uniq(DATA.map(d=>d.Top1_Categoria)).sort());
  minI.value=anos[0]||''; maxI.value=anos[anos.length-1]||'';
  S.min=Number(minI.value)||null; S.max=Number(maxI.value)||null;

  // Lectura multi-select
  function getMulti(el){ return [...el.selectedOptions].map(o=>o.value) }

  // Filtrado
  function passes(d){
    if(S.prog.length && !S.prog.includes(d.PROGRAMA)) return false;
    if(S.sector.length && !S.sector.includes(d.Sector)) return false;
    if(S.cats.length && !S.cats.includes(d.Top1_Categoria)) return false;
    if(S.min && (d.GRADO??Infinity) < S.min) return false;
    if(S.max && (d.GRADO??-Infinity) > S.max) return false;
    if(S.q){
      const q=S.q.toLowerCase();
      const blob = (d.Cargo+" "+d.Empresa+" "+d.Descripción).toLowerCase();
      if(!blob.includes(q)) return false;
    }
    return true;
  }
  function filtered(){ return DATA.filter(passes) }

  // KPIs
  const kTotal = document.getElementById('k-total');
  const kCat = document.getElementById('k-cat');
  const kOtro = document.getElementById('k-otro');

  // Tabla
  const TB = document.getElementById('tbody');
  const pinfo = document.getElementById('pinfo');
  function renderTable(rows){
    TB.innerHTML='';
    const start=(S.page-1)*S.size, end=start+S.size;
    const slice=rows.slice(start,end);
    slice.forEach(d=>{
      const tr=document.createElement('tr'); tr.className='tr'+(d.Top1_Categoria.toLowerCase()==='otro'?' hl-otro':'');
      const cells=[d.PROGRAMA,d.GRADO??'',d.Sector,d.Top1_Categoria,d.Cargo,d.Empresa,d.Descripción];
      cells.forEach(c=>{const td=document.createElement('td'); td.textContent=c; tr.appendChild(td)});
      TB.appendChild(tr);
    });
    pinfo.textContent = `${slice.length?start+1:0}-${Math.min(end, rows.length)} de ${fmt(rows.length)}`;
  }

  // CSV
  function toCSV(rows){
    const cols=['PROGRAMA','GRADO','Sector','Top1_Categoria','Cargo','Empresa','Descripción'];
    const head=cols.join(',');
    const esc=v=>('"'+String(v).replace(/"/g,'""')+'"');
    const body=rows.map(r=>cols.map(c=>esc(r[c]??'')).join(',')).join('\n');
    return head+'\n'+body;
  }
  document.getElementById('btn-csv').onclick=()=>{
    const blob=new Blob([toCSV(filtered())],{type:'text/csv;charset=utf-8;'});
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='egresados_filtrado.csv'; a.click();
  }

  // Gráficas (Chart.js)
  let cCats, cStack, cYear, cProg;
  function destroy(c){ if(c){ c.destroy(); } }

  function buildCharts(rows){
    // 1) Distribución por tema (Top N)
    const countCats={}; rows.forEach(r=>{ countCats[r.Top1_Categoria]=(countCats[r.Top1_Categoria]||0)+1 })
    const topN = sortByValDesc(countCats).slice(0,12);
    const labelsCats = topN.map(([k])=>k); const valsCats = topN.map(([,v])=>v);
    destroy(cCats);
    const ctx1=document.getElementById('chartCats');
    cCats=new Chart(ctx1,{type:'bar',data:{labels:labelsCats,datasets:[{label:'Registros',data:valsCats}]},options:{
      responsive:true,maintainAspectRatio:false,
      plugins:{legend:{display:false},tooltip:{callbacks:{label:(ctx)=>fmt(ctx.parsed.y)}}},
      scales:{x:{ticks:{color:'#cfd5e2',maxRotation:45,minRotation:0}},y:{ticks:{color:'#cfd5e2',callback:(v)=>fmt(v)}}}
    }});
    // Resalta "Otro"
    const idxOtro = labelsCats.findIndex(l=>l.toLowerCase()==='otro');
    if(idxOtro>=0){
      cCats.data.datasets[0].backgroundColor = labelsCats.map((l,i)=> i===idxOtro? 'rgba(255,205,87,0.7)':'rgba(106,169,255,0.6)');
      cCats.update();
      document.getElementById('card-cats').classList.add('hl-otro');
    } else {
      document.getElementById('card-cats').classList.remove('hl-otro');
    }

    // 2) Stacked Temas × Sector (Top 8 temas)
    const top8 = sortByValDesc(countCats).slice(0,8).map(([k])=>k);
    const sectors = uniq(rows.map(r=>r.Sector)).sort();
    const byCatSec = (cat, sec)=> rows.filter(r=>r.Top1_Categoria===cat && r.Sector===sec).length;
    const datasets = sectors.map(sec=>({label:sec,data:top8.map(cat=>byCatSec(cat,sec)),stack:'s'}));
    destroy(cStack);
    const ctx2=document.getElementById('chartStack');
    cStack=new Chart(ctx2,{type:'bar',data:{labels:top8,datasets},options:{responsive:true,maintainAspectRatio:false,
      scales:{x:{stacked:true,ticks:{color:'#cfd5e2'}},y:{stacked:true,ticks:{color:'#cfd5e2',callback:v=>fmt(v)}}},
      plugins:{tooltip:{callbacks:{label:(ctx)=> `${ctx.dataset.label}: ${fmt(ctx.parsed.y)}`}}}
    }});

    // 3) Serie por año de grado
    const byYear={}; rows.forEach(r=>{if(r.GRADO){byYear[r.GRADO]=(byYear[r.GRADO]||0)+1}});
    const yLabels = Object.keys(byYear).map(n=>+n).sort((a,b)=>a-b);
    const yVals = yLabels.map(y=>byYear[y]);
    destroy(cYear);
    const ctx3=document.getElementById('chartYear');
    cYear=new Chart(ctx3,{type:'line',data:{labels:yLabels,datasets:[{label:'Registros',data:yVals,fill:false,tension:.25}]},options:{
      responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},
      scales:{x:{ticks:{color:'#cfd5e2'}},y:{ticks:{color:'#cfd5e2',callback:v=>fmt(v)}}}
    }});

    // 4) Top temas por programa (apila los 6 más frecuentes por programa)
    const progs = uniq(rows.map(r=>r.PROGRAMA)).sort();
    const catsTop = uniq(sortByValDesc(countCats).slice(0,6).map(([k])=>k));
    const matrix = catsTop.map(cat=>({label:cat, data: progs.map(p=> rows.filter(r=>r.PROGRAMA===p && r.Top1_Categoria===cat).length), stack:'x'}));
    destroy(cProg);
    const ctx4=document.getElementById('chartProg');
    cProg=new Chart(ctx4,{type:'bar',data:{labels:progs,datasets:matrix},options:{responsive:true,maintainAspectRatio:false,
      scales:{x:{stacked:true,ticks:{color:'#cfd5e2'}},y:{stacked:true,ticks:{color:'#cfd5e2',callback:v=>fmt(v)}}}}
    });
  }

  // Render general
  function render(){
    const rows = filtered();
    // KPIs
    kTotal.textContent = fmt(rows.length);
    kCat.textContent = fmt(uniq(rows.map(r=>r.Top1_Categoria)).length);
    const otro = rows.filter(r=>r.Top1_Categoria.toLowerCase()==='otro').length;
    kOtro.textContent = rows.length? ((100*otro/rows.length).toFixed(1)+'%') : '0%';
    // Tabla
    S.page = 1; renderTable(rows);
    // Charts
    buildCharts(rows);
  }

  // Eventos
  selProg.onchange=()=>{S.prog=getMulti(selProg); render()}
  selSector.onchange=()=>{S.sector=getMulti(selSector); render()}
  selTop.onchange=()=>{S.cats=getMulti(selTop); render()}
  minI.oninput=()=>{S.min=Number(minI.value)||null; render()}
  maxI.oninput=()=>{S.max=Number(maxI.value)||null; render()}
  document.getElementById('btn-clear').onclick=()=>{
    [selProg,selSector,selTop].forEach(s=>{[...s.options].forEach(o=>o.selected=false)});
    S.prog=[]; S.sector=[]; S.cats=[]; S.min=Number(anos[0])||null; S.max=Number(anos.at(-1))||null; minI.value=S.min||''; maxI.value=S.max||''; S.q=''; document.getElementById('q').value=''; render();
  }
  document.getElementById('q').oninput=(e)=>{S.q=e.target.value.trim(); render()}
  document.getElementById('prev').onclick=()=>{ if(S.page>1){S.page--; renderTable(filtered())} }
  document.getElementById('next').onclick=()=>{ const rows=filtered(); if(S.page*S.size<rows.length){S.page++; renderTable(rows)} }

  // Inicio
  render();
  </script>
</body>
</html>

<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Treemap â€“ Tema de trabajo (Egresados)</title>

<!-- D3 v7 -->
<script src="https://d3js.org/d3.v7.min.js"></script>
<!-- SheetJS (XLSX parser) -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
  :root { --bg:#ffffff; --card:#f9fafb; --muted:#6b7280; --border:#e5e7eb; --ink:#111827; }
  * { box-sizing: border-box; }
  body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial; background:var(--bg); color:var(--ink); }
  header { padding: 16px 20px; background: #111827; color: #fff; }
  h1 { font-size: 18px; margin: 0; }
  .sub { color:#cbd5e1; font-size:12px; margin-top:4px; }
  .wrap { display:grid; grid-template-columns: 300px 1fr; gap:16px; padding:16px; }
  .panel { background:var(--card); border:1px solid var(--border); border-radius:12px; padding:12px; }
  label { display:block; font-weight:600; margin:10px 0 6px; }
  select, button, input[type="text"] {
    width:100%; padding:8px; border-radius:10px; border:1px solid #d1d5db; background:#fff;
  }
  .actions { display:flex; gap:8px; margin-top:10px; }
  .legend { display:flex; flex-wrap: wrap; gap:6px; margin-top:10px; }
  .legend-item { display:flex; align-items:center; gap:6px; padding:2px 6px; border-radius:6px; background:#fff; border:1px solid var(--border); }
  .legend-swatch { width:12px; height:12px; border-radius:3px; }
  #chart { width:100%; height:70vh; min-height:480px; border:1px solid var(--border); border-radius:12px; background:#fff; }
  .tooltip { position: fixed; pointer-events:none; background:rgba(17,24,39,0.92); color:#fff; padding:8px 10px; border-radius:8px; font-size:12px; opacity:0; transition:opacity .12s; z-index: 10; }
  .muted { color:var(--muted); }
  .details { font-size:14px; line-height:1.35; margin-top:10px; }
  .small { font-size:12px; }
  .err { color:#b91c1c; font-weight:600; }
  .row { display:flex; gap:8px; }
</style>
</head>
<body>
<header>
  <h1>ðŸŒ³ Treemap â€“ Tema de trabajo</h1>
  <div class="sub" id="fileMeta">Cargando Excelâ€¦</div>
</header>

<div class="wrap">
  <aside class="panel">
    <label>Fuente de datos (.xlsx)</label>
    <input id="xlsxUrl" type="text" placeholder="URL del Excel (o usa ?data=...)" />
    <div class="actions">
      <button id="btnLoad">Cargar</button>
      <button id="btnDemo">Demo (misma URL)</button>
    </div>
    <div id="status" class="small muted" style="margin-top:6px;"></div>

    <label for="programaSel">Filtrar por PROGRAMA</label>
    <input id="programaFilter" type="text" placeholder="Buscar programaâ€¦" />
    <select id="programaSel" multiple size="8"></select>

    <label for="gradoSel">Filtrar por AÃ‘O DE GRADO</label>
    <div class="row">
      <select id="gradoSel" multiple size="8" style="flex:1;"></select>
      <div style="display:flex;flex-direction:column;gap:6px;width:120px;">
        <input id="minYear" type="text" placeholder="mÃ­n (e.g. 2015)" />
        <input id="maxYear" type="text" placeholder="mÃ¡x (e.g. 2025)" />
      </div>
    </div>

    <div class="actions">
      <button id="aplicar">Aplicar</button>
      <button id="limpiar">Limpiar</button>
    </div>

    <div class="legend" id="legend"></div>
    <div style="margin-top:10px;" class="muted small">Tip: usa Ctrl/âŒ˜ o Shift para seleccionar varios.</div>
  </aside>

  <main class="panel">
    <div id="chart"></div>
    <div id="details" class="details">
      <div class="muted">Haz clic en un rectÃ¡ngulo para ver detalles.</div>
    </div>
  </main>
</div>

<div id="tooltip" class="tooltip"></div>

<script>
/* ============================ CONFIG ============================ */

const XLSX_URL = "PK";
/* =============================================================== */

const state = {
  rawRows: [],
  cleaned: [],
  cols: { programa: null, grado: null, tema: null },
  sheetName: null,
  fileName: null
};

const el = {
  fileMeta: document.getElementById('fileMeta'),
  status: document.getElementById('status'),
  xlsxUrl: document.getElementById('xlsxUrl'),
  btnLoad: document.getElementById('btnLoad'),
  btnDemo: document.getElementById('btnDemo'),
  programaFilter: document.getElementById('programaFilter'),
  programaSel: document.getElementById('programaSel'),
  gradoSel: document.getElementById('gradoSel'),
  minYear: document.getElementById('minYear'),
  maxYear: document.getElementById('maxYear'),
  aplicar: document.getElementById('aplicar'),
  limpiar: document.getElementById('limpiar'),
  chart: document.getElementById('chart'),
  legend: document.getElementById('legend'),
  tooltip: document.getElementById('tooltip'),
  details: document.getElementById('details'),
};

function getParam(name){
  const url = new URL(window.location.href);
  return url.searchParams.get(name);
}

function normalize(s){
  return String(s ?? "").trim().toLowerCase().replace(/\s+/g,' ');
}

function extractYear(v){
  if (v == null || v === "") return null;
  // Si ya es nÃºmero razonable
  const n = Number(v);
  if (!Number.isNaN(n)) {
    const y = Math.round(n);
    if (y >= 1950 && y <= 2100) return y;
  }
  const s = String(v);
  const m = s.match(/(19|20)\d{2}/);
  if (m) {
    const y = Number(m[0]);
    if (y >= 1950 && y <= 2100) return y;
  }
  const d = new Date(s);
  if (!isNaN(d.getTime())) {
    const y = d.getFullYear();
    if (y >= 1950 && y <= 2100) return y;
  }
  return null;
}

function pickBestSheet(workbook){
  // HeurÃ­stica: mayor puntaje por presencia de columnas objetivo
  let best = { name:null, score:-1, cols:[] };
  workbook.SheetNames.forEach(name => {
    const ws = workbook.Sheets[name];
    const json = XLSX.utils.sheet_to_json(ws, {defval: null});
    if (!json.length) return;
    const cols = Object.keys(json[0] ?? {});
    const nc = cols.map(c => normalize(c));
    const hasTema = nc.some(c => (c.includes("tema") && c.includes("trabajo")) || c === "tema de trabajo" || c === "temas de trabajo");
    const hasProg = nc.some(c => c === "programa" || c.includes("programa"));
    const hasGrad = nc.some(c => c.includes("grado") || (c.includes("aÃ±o") && (c.includes("grad") || c.includes("egres"))) || c === "year");
    const score = (hasTema?1:0) + (hasProg?1:0) + (hasGrad?1:0);
    const lenBoost = Math.min(cols.length, 6)*0.05;
    const s = score + lenBoost; // leve desempate por #cols
    if (s > best.score) best = { name, score:s, cols };
  });
  return best.name || workbook.SheetNames[0];
}

function detectColumns(rows){
  if (!rows.length) throw new Error("La hoja no tiene registros.");
  const cols = Object.keys(rows[0] ?? {});
  const byNorm = new Map(cols.map(c => [normalize(c), c]));
  const find = (patterns) => {
    for (const p of patterns){
      for (const [nk, orig] of byNorm.entries()){
        if (p.test(nk)) return orig;
      }
    }
    return null;
  };
  const programa = find([/\bprograma\b/]);
  const grado = find([/\bgrado\b/, /\baÃ±o.*grad/, /\baÃ±o.*egres/, /\baÃ±o\b/, /\byear\b/]);
  const tema = find([/\btema(?:\s+de)?\s+trabajo\b/, /\btema\b/]);
  return { programa, grado, tema };
}

function cleanRows(rows, cols){
  const out = [];
  const canonMap = new Map(); // canonicaliza por normalizaciÃ³n simple (espacios/case)
  const counts = new Map();
  // Primera pasada: normalizaciÃ³n leve para proponer forma canÃ³nica por frecuencia
  const tmp = rows.map(r => {
    const temaRaw = r[cols.tema];
    const temaStr = (temaRaw==null?"":String(temaRaw).trim());
    const key = normalize(temaStr);
    if (key) counts.set(key, (counts.get(key)||0)+1);
    return { r, key, temaStr };
  });
  const key2canon = new Map();
  for (const [key, cnt] of counts.entries()){
    // el "canÃ³nico" serÃ¡ el primer valor observado mÃ¡s frecuente (aquÃ­ simplificado al primero)
    key2canon.set(key, null);
  }
  for (const t of tmp){
    if (t.key && key2canon.get(t.key) == null) key2canon.set(t.key, t.temaStr);
  }
  // Segunda pasada: construir filas limpias
  for (const row of rows){
    const prog = row[cols.programa];
    const grad = row[cols.grado];
    const tema = row[cols.tema];

    const PROGRAMA = (prog==null || String(prog).trim()==="") ? null : String(prog).trim();
    const GRADO = extractYear(grad);
    const temaKey = normalize(tema);
    const TEMA = (!temaKey ? null : key2canon.get(temaKey) || String(tema).trim());

    if (TEMA) {
      out.push({ PROGRAMA, GRADO, "Tema de trabajo": TEMA });
    }
  }
  return out;
}

function uniq(arr){ return Array.from(new Set(arr.filter(v => v!=null))); }

function fillSelect(sel, options){
  sel.innerHTML = "";
  for (const o of options){
    const opt = document.createElement('option');
    opt.value = o;
    opt.textContent = String(o);
    sel.appendChild(opt);
  }
}

function setStatus(msg, isErr=false){
  el.status.textContent = msg;
  el.status.className = "small " + (isErr ? "err" : "muted");
}

async function loadXlsx(url){
  setStatus("Descargando Excelâ€¦");
  const res = await fetch(url);
  if (!res.ok) throw new Error(`No se pudo descargar el archivo (${res.status})`);
  const ab = await res.arrayBuffer();
  setStatus("Parseando Excelâ€¦");
  const wb = XLSX.read(ab, { type: "array" });
  const sheet = pickBestSheet(wb);
  const ws = wb.Sheets[sheet];
  const rows = XLSX.utils.sheet_to_json(ws, { defval: null });
  return { wb, rows, sheet };
}

function buildFilters(){
  const programas = uniq(state.cleaned.map(d => d.PROGRAMA)).sort((a,b)=>(a||"").localeCompare(b||""));
  const years = uniq(state.cleaned.map(d => d.GRADO)).sort((a,b)=>(a??0)-(b??0));
  fillSelect(el.programaSel, programas);
  fillSelect(el.gradoSel, years);
  // Sugerir rango min/max
  if (years.length){
    el.minYear.value = years[0];
    el.maxYear.value = years[years.length-1];
  } else {
    el.minYear.value = "";
    el.maxYear.value = "";
  }
}

function drawLegend(categories, color){
  const sel = d3.select(el.legend).selectAll(".legend-item").data(categories, d=>d);
  const enter = sel.enter().append("div").attr("class","legend-item");
  enter.append("div").attr("class","legend-swatch").style("background", d => color(d));
  enter.append("div").text(d => d);
  sel.exit().remove();
}

function getSelected(sel){
  return Array.from(sel.selectedOptions).map(o => o.value);
}

function applyFilters(){
  const selProg = getSelected(el.programaSel);
  const selGrad = getSelected(el.gradoSel).map(v => Number(v));
  const minY = Number(el.minYear.value) || -Infinity;
  const maxY = Number(el.maxYear.value) || Infinity;

  return state.cleaned.filter(d => {
    const okProg = selProg.length ? selProg.includes(d.PROGRAMA) : true;
    const okGradList = selGrad.length ? selGrad.includes(d.GRADO) : true;
    const okRange = (d.GRADO==null) ? false : (d.GRADO >= minY && d.GRADO <= maxY);
    return okProg && okGradList && okRange;
  });
}

function aggregateByTema(data){
  const m = new Map();
  for (const r of data){
    const k = r["Tema de trabajo"] || "â€”";
    m.set(k, (m.get(k)||0) + 1);
  }
  const out = Array.from(m.entries()).map(([name, value]) => ({ name, value }));
  out.sort((a,b)=> b.value - a.value);
  return out;
}

function renderTreemap(){
  const data = applyFilters();
  const total = data.length;
  const agg = aggregateByTema(data);
  const color = d3.scaleOrdinal(d3.schemeTableau10).domain(agg.map(d=>d.name));

  drawLegend(agg.map(d=>d.name), color);

  el.chart.innerHTML = "";
  const width = el.chart.clientWidth;
  const height = el.chart.clientHeight;

  const root = d3.hierarchy({ name:"root", children: agg })
    .sum(d => d.value)
    .sort((a,b)=> b.value - a.value);

  d3.treemap().size([width, height]).paddingInner(2).round(true)(root);

  const svg = d3.select("#chart").append("svg")
    .attr("width", width)
    .attr("height", height);

  const g = svg.selectAll("g")
    .data(root.leaves())
    .join("g")
    .attr("transform", d => `translate(${d.x0},${d.y0})`);

  g.append("rect")
    .attr("width", d => Math.max(0, d.x1 - d.x0))
    .attr("height", d => Math.max(0, d.y1 - d.y0))
    .attr("fill", d => color(d.data.name))
    .attr("rx",6).attr("ry",6)
    .on("mousemove", (ev, d) => {
      const pct = total ? ((d.data.value/total)*100).toFixed(1) : 0;
      el.tooltip.style.opacity = 1;
      el.tooltip.style.left = (ev.clientX+12)+"px";
      el.tooltip.style.top = (ev.clientY-12)+"px";
      el.tooltip.innerHTML = `<b>${d.data.name}</b><br>Conteo: ${d.data.value}<br>% del total: ${pct}%`;
    })
    .on("mouseleave", () => el.tooltip.style.opacity = 0)
    .on("click", (ev, d) => {
      const pct = total ? ((d.data.value/total)*100).toFixed(1) : 0;
      el.details.innerHTML = `
        <div><b>CategorÃ­a:</b> ${d.data.name}</div>
        <div><b>Conteo:</b> ${d.data.value}</div>
        <div><b>% del total:</b> ${pct}%</div>
      `;
    });

  // Etiquetas si hay espacio suficiente
  g.append("foreignObject")
    .attr("width", d => Math.max(0, d.x1 - d.x0))
    .attr("height", d => Math.max(0, d.y1 - d.y0))
    .append("xhtml:div")
    .style("width","100%")
    .style("height","100%")
    .style("display","flex")
    .style("align-items","center")
    .style("justify-content","center")
    .style("text-align","center")
    .style("padding","4px")
    .style("font-size","12px")
    .style("font-weight","600")
    .style("color","#111827")
    .style("pointer-events","none")
    .html(d => {
      const area = (d.x1 - d.x0) * (d.y1 - d.y0);
      const pct = total ? ((d.data.value/total)*100).toFixed(1) : 0;
      return area > 5000 ? `${d.data.name} Â· ${pct}%` : "";
    });
}

function refreshProgramaList(){
  const q = normalize(el.programaFilter.value || "");
  const programas = uniq(state.cleaned.map(d=>d.PROGRAMA)).filter(v => v!=null);
  const filtered = q ? programas.filter(p => normalize(p).includes(q)) : programas;
  fillSelect(el.programaSel, filtered.sort((a,b)=>a.localeCompare(b)));
}

async function bootstrap(){
  // Determina URL
  const param = getParam("data");
  const url = param || XLSX_URL;
  el.xlsxUrl.value = url || "";
  if (!url) {
    setStatus("Proporciona la URL del Excel (o ?data=URL).");
    return;
  }
  try{
    const { rows, sheet } = await loadXlsx(url);
    state.fileName = url.split("/").pop();
    state.sheetName = sheet;
    el.fileMeta.textContent = `${state.fileName || 'archivo.xlsx'} Â· hoja: ${state.sheetName}`;

    const cols = detectColumns(rows);
    if (!cols.tema) throw new Error("No encontrÃ© la columna 'Tema de trabajo' (intenta renombrar o revisar encabezados).");
    if (!cols.programa) setStatus("Advertencia: no encontrÃ© 'PROGRAMA' (el filtro se desactiva).", true);
    if (!cols.grado) setStatus("Advertencia: no encontrÃ© 'GRADO' (el filtro por aÃ±o se desactiva).", true);

    state.cols = cols;
    state.rawRows = rows;
    state.cleaned = cleanRows(rows, cols);

    setStatus(`Registros vÃ¡lidos: ${state.cleaned.length}`);

    buildFilters();
    renderTreemap();
  } catch(err){
    console.error(err);
    setStatus(`Error: ${err.message}`, true);
  }
}

/* === Eventos === */
el.btnLoad.addEventListener('click', async () => {
  const url = el.xlsxUrl.value.trim();
  if (!url) { setStatus("Ingresa una URL .xlsx vÃ¡lida.", true); return; }
  const qs = new URL(window.location.href);
  qs.searchParams.set("data", url);
  history.replaceState(null, "", qs.toString());
  bootstrap();
});

el.btnDemo.addEventListener('click', () => {
  // Recarga con la misma URL textfield (Ãºtil en GitHub Pages)
  const url = el.xlsxUrl.value.trim() || XLSX_URL;
  if (!url) { setStatus("Ingresa una URL .xlsx vÃ¡lida.", true); return; }
  const qs = new URL(window.location.href);
  qs.searchParams.set("data", url);
  history.replaceState(null, "", qs.toString());
  bootstrap();
});

el.aplicar.addEventListener('click', renderTreemap);
el.limpiar.addEventListener('click', () => {
  el.programaFilter.value = "";
  refreshProgramaList();
  Array.from(el.programaSel.options).forEach(o => o.selected=false);
  Array.from(el.gradoSel.options).forEach(o => o.selected=false);
  const years = uniq(state.cleaned.map(d => d.GRADO)).sort((a,b)=> (a??0)-(b??0));
  el.minYear.value = years.length ? years[0] : "";
  el.maxYear.value = years.length ? years[years.length-1] : "";
  renderTreemap();
});

el.programaFilter.addEventListener('input', refreshProgramaList);
window.addEventListener('resize', renderTreemap);

/* Arranca */
bootstrap();
</script>
</body>
</html>

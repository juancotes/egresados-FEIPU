<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Panel interactivo · Egresados FEIPU URosario</title>
  <!-- Tailwind (CDN) para estilos rápidos en un solo archivo -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Chart.js para gráficos -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <!-- SheetJS para leer Excel desde GitHub -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.19.3/dist/xlsx.full.min.js"></script>

  <style>
    /* Ajustes menores */
    .card { @apply bg-white rounded-2xl shadow p-5; }
    .kpi { @apply text-3xl font-semibold; }
    .label { @apply text-sm text-gray-500; }
    .chip { @apply inline-flex items-center gap-1 rounded-full px-2 py-1 text-xs bg-gray-100; }
    .table-header { @apply text-left text-xs font-medium text-gray-500 uppercase tracking-wider; }
    .table-row { @apply hover:bg-gray-50; }
    .btn { @apply inline-flex items-center gap-2 rounded-xl border px-3 py-2 text-sm font-medium; }
    .btn-primary { @apply bg-gray-900 text-white border-gray-900; }
    .btn-ghost { @apply border-gray-300 text-gray-700; }
    .select, .input { @apply rounded-xl border border-gray-300 px-3 py-2 text-sm; }
    .tooltip { position: relative; cursor: help; }
    .tooltip .tip { display:none; position:absolute; z-index:10; top:100%; left:0; margin-top:.25rem; @apply bg-gray-900 text-white text-xs rounded-lg px-2 py-1; white-space:nowrap; }
    .tooltip:hover .tip { display:block; }
  </style>
</head>
<body class="bg-gray-100 min-h-screen">
  <header class="bg-white border-b">
    <div class="max-w-7xl mx-auto px-4 py-5 flex flex-col sm:flex-row items-start sm:items-center justify-between gap-3">
      <div>
        <h1 class="text-2xl font-bold">Panel de egresados · FEIPU URosario</h1>
        <p class="text-gray-500 text-sm">Fuente: hoja <span class="font-mono">top3</span> del archivo Excel alojado en GitHub. Campos clave: <span class="font-mono">PROGRAMA</span>, <span class="font-mono">GRADO</span>, <span class="font-mono">Sector</span>, <span class="font-mono">Descripción</span>, <span class="font-mono">Top1_Categoria</span>, y opcionales <span class="font-mono">Cargo</span>, <span class="font-mono">Empresa</span>.</p>
      </div>
      <div class="flex items-center gap-2">
        <button id="btnReset" class="btn btn-ghost" title="Quitar todos los filtros">Reiniciar filtros</button>
        <button id="btnExport" class="btn btn-primary" title="Descargar resultados filtrados a CSV">Exportar CSV</button>
      </div>
    </div>
  </header>

  <main class="max-w-7xl mx-auto p-4 space-y-6">
    <!-- Carga de datos -->
    <section class="card">
      <div class="flex flex-col lg:flex-row gap-3 items-start lg:items-center justify-between">
        <div class="space-y-1">
          <div class="label">URL del Excel (GitHub raw):</div>
          <input id="excelUrl" class="input w-[min(100%,42rem)]" placeholder="https://raw.githubusercontent.com/usuario/repositorio/rama/ruta/archivo.xlsx" />
          <p class="text-xs text-gray-500">Sugerencia: usa la URL <span class="font-mono">raw.githubusercontent.com</span>. También puedes pasar <span class="font-mono">?data=URL</span> en la barra de direcciones.</p>
        </div>
        <div class="flex gap-2">
          <button id="btnCargar" class="btn btn-primary">Cargar datos</button>
          <span id="loadState" class="text-sm text-gray-500"></span>
        </div>
      </div>
    </section>

    <!-- Filtros -->
    <section class="card" id="filtros" style="display:none;">
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
        <div>
          <div class="label">Programa</div>
          <select id="fPROGRAMA" class="select w-full"></select>
        </div>
        <div>
          <div class="label">Grado</div>
          <select id="fGRADO" class="select w-full"></select>
        </div>
        <div>
          <div class="label">Sector</div>
          <select id="fSector" class="select w-full"></select>
        </div>
        <div>
          <div class="label flex items-center gap-2">Top1_Categoria
            <span class="tooltip">ℹ️
              <span class="tip">«otro» indica sector distinto/no clasificable o información insuficiente.</span>
            </span>
          </div>
          <select id="fTop1" class="select w-full"></select>
        </div>
        <div class="md:col-span-2">
          <div class="label">Búsqueda libre en Descripción</div>
          <input id="qDescripcion" class="input w-full" placeholder="palabra clave en Descripción…"/>
        </div>
        <div>
          <div class="label">Empresa (texto libre)</div>
          <input id="qEmpresa" class="input w-full" placeholder="contiene…"/>
        </div>
        <div>
          <div class="label">Cargo (texto libre)</div>
          <input id="qCargo" class="input w-full" placeholder="contiene…"/>
        </div>
        <div class="flex items-center gap-2">
          <input id="chkExcluirOtro" type="checkbox" class="h-4 w-4" />
          <label for="chkExcluirOtro" class="text-sm">Excluir «otro» en Top1_Categoria</label>
        </div>
      </div>
    </section>

    <!-- KPIs -->
    <section class="grid grid-cols-1 md:grid-cols-3 gap-4" id="kpis" style="display:none;">
      <div class="card">
        <div class="label">Egresados (filtrados)</div>
        <div id="kpiTotal" class="kpi">—</div>
      </div>
      <div class="card">
        <div class="label">Programas (únicos)</div>
        <div id="kpiProgramas" class="kpi">—</div>
      </div>
      <div class="card">
        <div class="label">Categorías (Top1_Categoria)</div>
        <div id="kpiCats" class="kpi">—</div>
      </div>
    </section>

    <!-- Gráficos -->
    <section class="grid grid-cols-1 lg:grid-cols-2 gap-4" id="charts" style="display:none;">
      <div class="card">
        <div class="flex items-center justify-between">
          <h2 class="font-semibold">Distribución por Top1_Categoria</h2>
          <span id="top1Legend" class="text-xs text-gray-500"></span>
        </div>
        <canvas id="chartTop1" height="220"></canvas>
      </div>
      <div class="card">
        <div class="flex items-center justify-between">
          <h2 class="font-semibold">Distribución por Sector</h2>
          <span id="sectorLegend" class="text-xs text-gray-500"></span>
        </div>
        <canvas id="chartSector" height="220"></canvas>
      </div>
    </section>

    <!-- Tabla -->
    <section class="card" id="tablaWrap" style="display:none;">
      <div class="flex items-center justify-between mb-3">
        <h2 class="font-semibold">Registros</h2>
        <div class="text-xs text-gray-500" id="resultInfo">—</div>
      </div>
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th class="table-header px-3 py-2">PROGRAMA</th>
              <th class="table-header px-3 py-2">GRADO</th>
              <th class="table-header px-3 py-2">Sector</th>
              <th class="table-header px-3 py-2">Top1_Categoria</th>
              <th class="table-header px-3 py-2">Descripción</th>
              <th class="table-header px-3 py-2">Cargo</th>
              <th class="table-header px-3 py-2">Empresa</th>
            </tr>
          </thead>
          <tbody id="tbody" class="divide-y divide-gray-100 bg-white"></tbody>
        </table>
      </div>
      <div class="flex items-center justify-between mt-4">
        <div class="text-sm text-gray-500">Página <span id="pageNow">1</span> de <span id="pageTotal">1</span></div>
        <div class="flex gap-2">
          <button id="prevPage" class="btn btn-ghost">Anterior</button>
          <select id="pageSize" class="select">
            <option>10</option>
            <option selected>25</option>
            <option>50</option>
            <option>100</option>
          </select>
          <button id="nextPage" class="btn btn-ghost">Siguiente</button>
        </div>
      </div>
    </section>

    <footer class="text-center text-xs text-gray-500 py-6">
      Hecho en HTML único · Puedes versionarlo en GitHub sin dependencias de build. 
    </footer>
  </main>

<script>
  /********************************************
   * Utilidades
   ********************************************/
  const SHEET_NAME = 'top3';
  const COLS = {
    PROGRAMA: 'PROGRAMA',
    GRADO: 'GRADO',
    Sector: 'Sector',
    Descripcion: 'Descripción',
    Top1: 'Top1_Categoria',
    Cargo: 'Cargo',
    Empresa: 'Empresa',
  };

  const qs = (s, el=document) => el.querySelector(s);
  const qsa = (s, el=document) => Array.from(el.querySelectorAll(s));

  function deaccent(str){
    if(!str) return '';
    return str.normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase();
  }
  function unique(arr){ return Array.from(new Set(arr.filter(x=>x!=null && x!==''))).sort((a,b)=> String(a).localeCompare(String(b))); }
  function countBy(arr, key){
    const m = new Map();
    for(const x of arr){ m.set(x, (m.get(x)||0)+1); }
    return Array.from(m.entries()).sort((a,b)=> b[1]-a[1]);
  }
  function downloadText(filename, text){
    const blob = new Blob([text], {type:'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = filename; a.click();
    URL.revokeObjectURL(url);
  }

  /********************************************
   * Estado global
   ********************************************/
  let RAW = [];// datos completos
  let VIEW = [];// datos filtrados
  let PAGE = 1;
  let PAGE_SIZE = 25;
  let chartTop1, chartSector;

  /********************************************
   * Carga del Excel
   ********************************************/
  async function fetchArrayBuffer(url){
    const res = await fetch(url);
    if(!res.ok) throw new Error('No se pudo descargar el Excel: '+res.status);
    return await res.arrayBuffer();
  }

  function readSheet(arrayBuffer){
    const wb = XLSX.read(arrayBuffer, {type:'array'});
    const sheet = wb.Sheets[SHEET_NAME] || wb.Sheets[wb.SheetNames[0]];
    if(!sheet) throw new Error('No se encontró la hoja '+SHEET_NAME);
    let rows = XLSX.utils.sheet_to_json(sheet, {defval:''});
    // Normalizar columnas esperadas
    rows = rows.map(r=>({
      [COLS.PROGRAMA]: r[COLS.PROGRAMA] ?? r['Programa'] ?? '',
      [COLS.GRADO]: r[COLS.GRADO] ?? r['Grado'] ?? '',
      [COLS.Sector]: r[COLS.Sector] ?? r['SECTOR'] ?? '',
      [COLS.Descripcion]: r[COLS.Descripcion] ?? r['Descripcion'] ?? r['DESCRIPCION'] ?? r['DESCRIPCIÓN'] ?? '',
      [COLS.Top1]: r[COLS.Top1] ?? r['Top1'] ?? r['TOP1_CATEGORIA'] ?? '',
      [COLS.Cargo]: r[COLS.Cargo] ?? r['CARGO'] ?? '',
      [COLS.Empresa]: r[COLS.Empresa] ?? r['EMPRESA'] ?? '',
    }));
    return rows;
  }

  async function loadExcel(url){
    setLoadState('Descargando…');
    const buf = await fetchArrayBuffer(url);
    setLoadState('Leyendo hoja…');
    RAW = readSheet(buf);
    setLoadState('Listo ('+RAW.length+' filas)');
    initFilters(RAW);
    PAGE = 1;
    applyFilters();
    qs('#filtros').style.display = '';
    qs('#kpis').style.display = '';
    qs('#charts').style.display = '';
    qs('#tablaWrap').style.display = '';
  }

  function setLoadState(msg){ qs('#loadState').textContent = msg; }

  /********************************************
   * Filtros
   ********************************************/
  function fillSelect(sel, values){
    sel.innerHTML = '';
    const optAll = document.createElement('option');
    optAll.value = ''; optAll.textContent = '— Todos —';
    sel.appendChild(optAll);
    for(const v of values){
      const opt = document.createElement('option');
      opt.value = v; opt.textContent = v || '(vacío)';
      sel.appendChild(opt);
    }
  }

  function initFilters(data){
    fillSelect(qs('#fPROGRAMA'), unique(data.map(d=>d[COLS.PROGRAMA])));
    fillSelect(qs('#fGRADO'), unique(data.map(d=>d[COLS.GRADO])));
    fillSelect(qs('#fSector'), unique(data.map(d=>d[COLS.Sector])));
    fillSelect(qs('#fTop1'), unique(data.map(d=>d[COLS.Top1])));
  }

  function applyFilters(){
    const fProg = qs('#fPROGRAMA').value;
    const fGrado = qs('#fGRADO').value;
    const fSector = qs('#fSector').value;
    const fTop1 = qs('#fTop1').value;
    const qDesc = deaccent(qs('#qDescripcion').value);
    const qEmp = deaccent(qs('#qEmpresa').value);
    const qCargo = deaccent(qs('#qCargo').value);
    const exclOtro = qs('#chkExcluirOtro').checked;

    VIEW = RAW.filter(r=>{
      if(fProg && r[COLS.PROGRAMA] !== fProg) return false;
      if(fGrado && r[COLS.GRADO] !== fGrado) return false;
      if(fSector && r[COLS.Sector] !== fSector) return false;
      if(fTop1 && r[COLS.Top1] !== fTop1) return false;
      if(exclOtro && (String(r[COLS.Top1]).toLowerCase().trim() === 'otro')) return false;
      if(qDesc && !deaccent(String(r[COLS.Descripcion])).includes(qDesc)) return false;
      if(qEmp && !deaccent(String(r[COLS.Empresa])).includes(qEmp)) return false;
      if(qCargo && !deaccent(String(r[COLS.Cargo])).includes(qCargo)) return false;
      return true;
    });

    updateKPIs();
    updateCharts();
    renderTable();
  }

  function resetFilters(){
    qsa('select').forEach(s=> s.value='');
    qsa('input').forEach(i=>{ if(i.type==='text') i.value=''; if(i.type==='checkbox') i.checked=false; });
    PAGE = 1;
    applyFilters();
  }

  /********************************************
   * KPIs y Gráficos
   ********************************************/
  function updateKPIs(){
    qs('#kpiTotal').textContent = VIEW.length.toLocaleString('es-CO');
    qs('#kpiProgramas').textContent = unique(VIEW.map(d=>d[COLS.PROGRAMA])).length;
    qs('#kpiCats').textContent = unique(VIEW.map(d=>d[COLS.Top1])).length;
  }

  function ensureChart(ctx, cfg, ref){
    if(ref) { ref.destroy(); }
    return new Chart(ctx, cfg);
  }

  function topNCount(arr, n=12){
    const pairs = countBy(arr, x=>x);
    const items = pairs.map(([k,v])=>({k,v}));
    return items.slice(0,n);
  }

  function updateCharts(){
    const catCounts = countBy(VIEW.map(d=>d[COLS.Top1]||'(vacío)'));
    const secCounts = countBy(VIEW.map(d=>d[COLS.Sector]||'(vacío)'));

    qs('#top1Legend').textContent = `${catCounts.length} categorías`;
    qs('#sectorLegend').textContent = `${secCounts.length} sectores`;

    const topCats = catCounts.slice(0,12);
    const topSecs = secCounts.slice(0,12);

    chartTop1 = ensureChart(qs('#chartTop1'), {
      type: 'bar',
      data: {
        labels: topCats.map(d=>d[0]),
        datasets: [{ label: 'Egresados', data: topCats.map(d=>d[1]) }]
      },
      options: { responsive: true, maintainAspectRatio: false, scales: { x: { ticks: { autoSkip: false } } } }
    }, chartTop1);

    chartSector = ensureChart(qs('#chartSector'), {
      type: 'bar',
      data: {
        labels: topSecs.map(d=>d[0]),
        datasets: [{ label: 'Egresados', data: topSecs.map(d=>d[1]) }]
      },
      options: { responsive: true, maintainAspectRatio: false, scales: { x: { ticks: { autoSkip: false } } } }
    }, chartSector);
  }

  /********************************************
   * Tabla
   ********************************************/
  function renderTable(){
    const tbody = qs('#tbody');
    tbody.innerHTML = '';
    PAGE_SIZE = parseInt(qs('#pageSize').value,10);

    const totalPages = Math.max(1, Math.ceil(VIEW.length / PAGE_SIZE));
    PAGE = Math.min(PAGE, totalPages);
    const start = (PAGE-1)*PAGE_SIZE;
    const rows = VIEW.slice(start, start+PAGE_SIZE);

    for(const r of rows){
      const tr = document.createElement('tr');
      tr.className = 'table-row';
      tr.innerHTML = `
        <td class="px-3 py-2 text-sm text-gray-800">${escapeHtml(r[COLS.PROGRAMA])}</td>
        <td class="px-3 py-2 text-sm text-gray-800">${escapeHtml(r[COLS.GRADO])}</td>
        <td class="px-3 py-2 text-sm text-gray-800">${escapeHtml(r[COLS.Sector])}</td>
        <td class="px-3 py-2 text-sm">${badge(r[COLS.Top1])}</td>
        <td class="px-3 py-2 text-sm text-gray-700">${escapeHtml(r[COLS.Descripcion])}</td>
        <td class="px-3 py-2 text-sm text-gray-700">${escapeHtml(r[COLS.Cargo])}</td>
        <td class="px-3 py-2 text-sm text-gray-700">${escapeHtml(r[COLS.Empresa])}</td>
      `;
      tbody.appendChild(tr);
    }

    qs('#pageNow').textContent = PAGE;
    qs('#pageTotal').textContent = Math.max(1, Math.ceil(VIEW.length / PAGE_SIZE));
    qs('#resultInfo').textContent = `${VIEW.length.toLocaleString('es-CO')} resultados`;
  }

  function badge(v){
    const txt = String(v||'(vacío)');
    const isOtro = txt.trim().toLowerCase()==='otro';
    return `<span class="chip ${isOtro ? 'bg-yellow-100' : 'bg-gray-100'}">${escapeHtml(txt)}</span>`;
  }

  function escapeHtml(s){
    return String(s==null?'':s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');
  }

  /********************************************
   * Exportar CSV de la vista
   ********************************************/
  function exportCSV(){
    const header = ['PROGRAMA','GRADO','Sector','Top1_Categoria','Descripción','Cargo','Empresa'];
    const lines = [header.join(',')];
    for(const r of VIEW){
      const row = [r[COLS.PROGRAMA], r[COLS.GRADO], r[COLS.Sector], r[COLS.Top1], r[COLS.Descripcion], r[COLS.Cargo], r[COLS.Empresa]]
        .map(x=>`"${String(x??'').replaceAll('"','""')}"`)
        .join(',');
      lines.push(row);
    }
    downloadText('egresados_filtrados.csv', lines.join('\n'));
  }

  /********************************************
   * Eventos UI
   ********************************************/
  function bindEvents(){
    ['#fPROGRAMA','#fGRADO','#fSector','#fTop1','#qDescripcion','#qEmpresa','#qCargo','#chkExcluirOtro','#pageSize']
      .forEach(id=> qs(id).addEventListener(id==='#pageSize' ? 'change' : (id.startsWith('#q')?'input':'change'), ()=>{ PAGE=1; applyFilters(); }));

    qs('#prevPage').addEventListener('click', ()=>{ if(PAGE>1){ PAGE--; renderTable(); } });
    qs('#nextPage').addEventListener('click', ()=>{ const total = Math.max(1, Math.ceil(VIEW.length / PAGE_SIZE)); if(PAGE<total){ PAGE++; renderTable(); } });
    qs('#btnReset').addEventListener('click', resetFilters);
    qs('#btnExport').addEventListener('click', exportCSV);
    qs('#btnCargar').addEventListener('click', ()=>{
      const url = qs('#excelUrl').value.trim();
      if(!url){ alert('Indica la URL del Excel en GitHub (raw)'); return; }
      loadExcel(url).catch(err=> setLoadState('Error: '+err.message));
    });
  }

  // Lee ?data=URL si viene en la barra
  function initFromQuery(){
    try{
      const u = new URL(window.location.href);
      const dataUrl = u.searchParams.get('data');
      if(dataUrl){ qs('#excelUrl').value = dataUrl; }
    }catch(_){ /* no-op */ }
  }

  document.addEventListener('DOMContentLoaded', ()=>{
    bindEvents();
    initFromQuery();
  });
</script>
</body>
</html>
